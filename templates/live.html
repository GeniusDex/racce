{{$server := .Server}}
{{$state := $server.LiveState}}

{{template "header.inc.html" "Live"}}

<div class="mdl-grid">
    <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-cell--top">
        <div class="mdl-card__title mdl-card--table__header">
            <h2 class="mdl-card__title-text mdl-typography--title" id="live_title">{{$server.Cfg.Settings.ServerName}}</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <ul class="mdl-list server_status">
                <li class="mdl-list__item" data-serverstate="online">
                    <i class="material-icons mdl-list__item-icon server_running">play_arrow</i>
                    Online
                </li>
                <li class="mdl-list__item" data-serverstate="not_registered">
                    <i class="material-icons mdl-list__item-icon server_not_registered">play_arrow</i>
                    Not Registered
                </li>
                <li class="mdl-list__item" data-serverstate="starting">
                    <i class="material-icons mdl-list__item-icon server_starting">fast_forward</i>
                    Starting
                </li>
                <li class="mdl-list__item" data-serverstate="offline">
                    <i class="material-icons mdl-list__item-icon server_stopped">stop</i>
                    Offline
                </li>
                <li class="mdl-list__item" data-serverisrunning="true">
                    <i class="material-icons mdl-list__item-icon server_log">people</i>
                    <span id="live_nrclients"></span>
                </li>
                <li class="mdl-list__item" data-serverisrunning="true">
                    <i class="material-icons mdl-list__item-icon server_log">place</i>
                    <span id="live_track"></span>
                </li>
            </ul>
        </div>
    </div>
</div>

<script type="text/javascript">
function hideElement(element)
{
    element.style.display = 'none';
}

function showElement(element)
{
    element.style.display = '';
}

function dataSelectorFor(key, value)
{
    if (value === undefined)
    {
        return '[data-' + key + ']';
    }
    else
    {
        return '[data-' + key + '=' + value + ']';
    }
}

function hideAll(key, value)
{
    document.querySelectorAll(dataSelectorFor(key, value)).forEach(hideElement);
}

function showAll(key, value)
{
    document.querySelectorAll(dataSelectorFor(key, value)).forEach(showElement);
}

function setServerState(state)
{
    hideAll('serverstate');
    hideAll('serverisrunning');

    showAll('serverstate', state);
    showAll('serverisrunning', (state == 'online' || state == 'not_registered') ? 'true' : 'false');
}

function setNrClients(nrClients)
{
    var plural = (nrClients == 1) ? '' : 's';
    document.getElementById('live_nrclients').innerText = `${nrClients} client${plural} online`;
}

function setTrack(track)
{
    document.getElementById('live_track').innerText = `${track.Name} (${track.Competition.Year})`;
}


document.addEventListener('DOMContentLoaded', function()
{
    setServerState('{{$state.ServerState}}');
    setNrClients({{$state.NrClients}});
    setTrack({{$state.Track}});
}, false);

function webSocketEndpoint()
{
    var protocol = ((window.location.protocol === "https:") ? "wss:" : "ws:");
    return protocol + "//" + window.location.host + window.location.pathname + "/ws";
}

var webSocket = new WebSocket(webSocketEndpoint());

webSocket.addEventListener('error', function(event)
{
    console.log(event);
});

webSocket.addEventListener('close', function(event)
{
    console.log(event);
    document.getElementById("live_title").classList.add("live_socket_disconnected");
});

var messageHandlers = {};

webSocket.addEventListener('message', function(event)
{
    var messages = event.data.split('\n');
    for (var i = 0; i < messages.length; i++)
    {
        if (messages[i].length > 0)
        {
            var msg = JSON.parse(messages[i]);
            if ('type' in msg && 'data' in msg && msg.type in messageHandlers)
            {
                messageHandlers[msg.type](msg.data);
            }
            else
            {
                console.log('Ignoring unexpected message', msg);
            }
        }
    }
});

function newHandler(type, handler)
{
    messageHandlers[type] = handler;
}

newHandler('serverState', setServerState);
newHandler('nrClients', setNrClients);
newHandler('track', setTrack);
</script>


{{template "footer.inc.html"}}
