{{$server := .Server}}
{{$state := $server.LiveState}}

{{template "header.inc.html" "Live"}}

<div class="mdl-grid">
    <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-cell--top">
        <div class="mdl-card__title mdl-card--table__header">
            <h2 class="mdl-card__title-text mdl-typography--title" id="live_title">{{$server.Cfg.Settings.ServerName}}</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <ul class="mdl-list server_status">
                <li class="mdl-list__item" data-serverstate="online">
                    <i class="material-icons mdl-list__item-icon server_running">play_arrow</i>
                    Online
                </li>
                <li class="mdl-list__item" data-serverstate="not_registered">
                    <i class="material-icons mdl-list__item-icon server_not_registered">play_arrow</i>
                    Online (Not Registered)
                </li>
                <li class="mdl-list__item" data-serverstate="starting">
                    <i class="material-icons mdl-list__item-icon server_starting">fast_forward</i>
                    Starting
                </li>
                <li class="mdl-list__item" data-serverstate="offline">
                    <i class="material-icons mdl-list__item-icon server_stopped">stop</i>
                    Offline
                </li>
                <li class="mdl-list__item" data-serverisrunning="true">
                    <i class="material-icons mdl-list__item-icon server_log">people</i>
                    <span id="live_nrclients"></span>
                </li>
                <li class="mdl-list__item" data-serverisrunning="true">
                    <i class="material-icons mdl-list__item-icon server_log">place</i>
                    <span id="live_track"></span>
                </li>
            </ul>
        </div>
    </div>
    <div class="mdl-card mdl-shadow--2dp mdl-cell mdl-cell--6-col mdl-cell--top" data-serverisrunning="true">
        <div class="mdl-card__title mdl-card--table__header">
            <h2 class="mdl-card__title-text mdl-typography--title">Leaderboard</h2>
        </div>
        <table class="mdl-data-table mdl-js-data-table sessionleaderboard live_leaderboard" id="live_leaderboard">
            <thead>
                <tr>
                    <th>Pos</th>
                    <th colspan="2">Car</th>
                    <th class="mdl-data-table__cell--non-numeric">Driver</th>
                    <th>Interval</th>
                </tr>
            </thead>
            <tbody id="live_leaderboard_body">
            </tbody>
        </table>
    </div>
</div>

<script type="text/javascript">
function hideElement(element)
{
    element.style.display = 'none';
}

function showElement(element)
{
    element.style.display = '';
}

function dataSelectorFor(key, value)
{
    if (value === undefined)
    {
        return '[data-' + key + ']';
    }
    else
    {
        return '[data-' + key + '=' + value + ']';
    }
}

function hideAll(key, value)
{
    document.querySelectorAll(dataSelectorFor(key, value)).forEach(hideElement);
}

function showAll(key, value)
{
    document.querySelectorAll(dataSelectorFor(key, value)).forEach(showElement);
}

function setServerState(state)
{
    hideAll('serverstate');
    hideAll('serverisrunning');

    showAll('serverstate', state);
    showAll('serverisrunning', (state == 'online' || state == 'not_registered') ? 'true' : 'false');
}

function setNrClients(nrClients)
{
    var plural = (nrClients == 1) ? '' : 's';
    document.getElementById('live_nrclients').innerText = `${nrClients} client${plural} online`;
}

function setTrack(track)
{
    document.getElementById('live_track').innerText = `${track.Name} (${track.Competition.Year})`;
}

var g_leaderboardTable = document.getElementById("live_leaderboard");
var g_leaderboardTBody = document.getElementById("live_leaderboard_body");
var g_leaderboardCarRows = {};

function getTableEntryForCarID(carID, carState)
{
    if (g_leaderboardCarRows[carID] === undefined)
    {
        var row = g_leaderboardTable.insertRow(-1);
        entry = {
            state: carState,
            row: row,
            cellPosition: row.insertCell(0),
            cellCarLogo: row.insertCell(1),
            cellRaceNumber: row.insertCell(2),
            cellDriver: row.insertCell(3),
            cellInterval: row.insertCell(4),
        };
        entry.cellCarLogo.classList.add('carlogo');
        entry.cellRaceNumber.classList.add('racenumber');
        entry.cellDriver.classList.add('mdl-data-table__cell--non-numeric');
        g_leaderboardCarRows[carID] = entry
    }
    else
    {
        g_leaderboardCarRows[carID].state = carState;
    }
    return g_leaderboardCarRows[carID];
}

function sortLeaderboardTable()
{
    Object.values(g_leaderboardCarRows)
        .sort(function(a, b)
        {
            if (a.state.BestLapMS > 0)
            {
                if (b.state.BestLapMS > 0) // Both A and B have lap
                    return a.state.BestLapMS - b.state.BestLapMS;
                else // A has lap, B has no lap
                    return -1;
            }
            else if (b.state.BestLapMS > 0) // A has no lap, B has lap
                return 1
            else // Neither A nor B has lap
                return a.state.Position - b.state.Position;
        })
        .forEach(function(item, index)
        {
            item.cellPosition.innerText = (index + 1).toString() + '.';
            g_leaderboardTBody.appendChild(item.row)
        });
}

function formatLapTime(lapTime_ms)
{
    if (lapTime_ms <= 0)
        return '-';
    var ms = lapTime_ms % 1000;
    var lapTime_s = (lapTime_ms - ms) / 1000;
    var s = lapTime_s % 60;
    var m = (lapTime_s - s) / 60;
    return m.toString().padStart(2, '0') + ':' + s.toString().padStart(2, '0') + '.' + ms.toString().padStart(3, '0');
}

function setCarState(carState)
{
    var entry = getTableEntryForCarID(carState.CarID, carState);

    if (carState.Drivers === null || carState.Drivers.length == 0)
        entry.row.classList.add('car_without_current_drivers');
    else
        entry.row.classList.remove('car_without_current_drivers');

    entry.cellPosition.innerText = `${carState.Position}.`;

    while (entry.cellCarLogo.firstChild)
        entry.cellCarLogo.removeChild(entry.cellCarLogo.lastChild);
    var carLogo = document.createElement('img');
    carLogo.src = {{basePath}} + `/static/carlogo/${carState.CarModel.ManufacturerLabel}.png`;
    carLogo.title = `${carState.CarModel.Manufacturer} ${carState.CarModel.Model}`;
    entry.cellCarLogo.appendChild(carLogo);
    
    entry.cellRaceNumber.innerText = `${carState.RaceNumber}`;
    
    if (carState.CurrentDriver !== null)
        entry.cellDriver.innerText = `${carState.CurrentDriver.Name}`;
    else
        entry.cellDriver.innerText = '-';
    
    entry.cellInterval.innerText = formatLapTime(carState.BestLapMS);
    // console.log(carState);

    sortLeaderboardTable();
}

function purgeCar(carID)
{
    if (g_leaderboardCarRows[carID] !== undefined)
    {
        g_leaderboardTable.deleteRow(g_leaderboardCarRows[carID].row.rowIndex);
        delete g_leaderboardCarRows[carID];
    }
}

document.addEventListener('DOMContentLoaded', function()
{
    setServerState('{{$state.ServerState}}');
    setNrClients({{$state.NrClients}});
    setTrack({{$state.Track}});
    {{range (sortOn $state.CarState ".Position")}}
        setCarState({{.}});
    {{end}}
}, false);

function webSocketEndpoint()
{
    var protocol = ((window.location.protocol === "https:") ? "wss:" : "ws:");
    var wsslash = (window.location.pathname.substr(-1) == "/") ? "" : "/";
    return protocol + "//" + window.location.host + window.location.pathname + wsslash + "ws";
}

var g_webSocket = new WebSocket(webSocketEndpoint());

g_webSocket.addEventListener('error', function(event)
{
    console.log(event);
});

g_webSocket.addEventListener('close', function(event)
{
    console.log(event);
    document.getElementById("live_title").classList.add("live_socket_disconnected");
});

var messageHandlers = {};

g_webSocket.addEventListener('message', function(event)
{
    var messages = event.data.split('\n');
    for (var i = 0; i < messages.length; i++)
    {
        if (messages[i].length > 0)
        {
            var msg = JSON.parse(messages[i]);
            if ('type' in msg && 'data' in msg && msg.type in messageHandlers)
            {
                messageHandlers[msg.type](msg.data);
            }
            else
            {
                console.log('Ignoring unexpected message', msg);
            }
        }
    }
});

function newHandler(type, handler)
{
    messageHandlers[type] = handler;
}

newHandler('serverState', setServerState);
newHandler('nrClients', setNrClients);
newHandler('track', setTrack);
newHandler('carState', setCarState);
newHandler('carPurged', purgeCar);
</script>


{{template "footer.inc.html"}}
